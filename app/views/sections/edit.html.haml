- form_for @section do |f|
  = render :partial => 'form', :locals => { :f => f }
  %p.submit
    = f.submit "Update"

#section-content.container
  .span-17
    .add-article-inset.simple.span-17.ui-block.js-only.js-staging
      .header.clear
        %h6.info New Article
      .remote_content
    .clear

    - ordered, unordered = @section.placements.partition { |p| p.list_order }
    %ol#top-items.plain.section_placements.ui-block
      %h6.info
        Top Items
      .clear
      .content
        - if ordered and !ordered.empty?
          - for placement in ordered
            = render :partial => 'sections/list/placement', :locals => { :placement => placement }

    %ul#recent-items.plain.section_placements.ui-block
      %h6.info
        Recent Items
      .clear
      .content
        - if unordered and !unordered.empty?
          - for placement in unordered
            = render :partial => 'sections/list/placement', :locals => { :placement => placement }
    
  -#= link_to "new", new_section_article_path(:section_id => @section ), :class => 'add button'
  .span-3.prepend-3
    - unless @section.placements.empty?
      %ul#remove-items.plain.ui-block
        %h6#remove-title.info
          Remove
        .clear

  .span-6
    .new.section_placements.ui-block
      %h6.info
        Add
      .clear
      - form_for @section.placements.build do |f|
        = f.select "article_id", article_options( :exclude_section => @section ), {}, :id => 'add_article_select'
        = f.hidden_field "section_id"
        = f.submit "Add", :id => 'add_article_button'

      = link_to "new article", new_section_article_path(:section_id => @section ), :class => 'add button remote_add', :'data-target' => '#section-content .add-article-inset', :id => 'add_article_link'

  #remote-staging.js-only.js-staging

- content_for :dom_ready do
  = "var auth_token = '#{form_authenticity_token}'"
  = "RD.section = #{@section.to_json}.section;"
  :plain
    var success_message = function(response) { RD.notify("success"); };
    //Create a new Article
    $('#section-content').click(  function(ev) {
      if( $(ev.target).is('.remote_add')) { 
        RD.articles.add(ev);
        return false; 
      }
      if( $(ev.target).is('.remote_edit')) { 
        RD.articles.edit(ev);
        return false;
      }
    } );

-# content_for :dom_ready do
  = "var auth_token = '#{form_authenticity_token}'"
  = "var section = #{@section.to_json}.section;"
  :plain
    var success_message = function(response) { RD.notify("success"); };
    //Create a new Article
    $('#add_article_link').click( function(ev) {
      var display = $(ev.target).attr('data-target');
      $.get('/sections/' + section.id + '/articles/new', {}, function( response ) {
        $(display).addClass('peeking').html( $('<h3></h3>').text('New Article')).append( response ).removeClass('peeking', 2500 ).find(':submit').click( function( ev ) {
          var form = $(ev.target.form);
          $.post( form.attr('action') + '.js', form.serialize(), function( response ) { 
            $('#recent-items').append( $('<li id="placement_ids_' + response.article.placements[0].id + '" data-article-id="'+response.article.id+'" class="peeking"></li>').append($('<h2></h2>').text( response.article.title )));
            $(display).addClass('peeking', 1500 );

            var new_article = $('#recent-items li:last' );
            form.effect('transfer', { to: new_article, className:'shadow' }, 300, function() {
              new_article.removeClass('peeking', 500 );
              success_message();  
            } );
          }, 'json');
          return false;
        } );
        
        $('.submit .cancel', display ).click( function() { 
          $( display ).addClass('peeking', 2000).html('')
          window.setTimeout( function() { $(display).removeClass('peeking'); }, 3000 );
          return false; 
        } );
      } );
      window.location.hash="add_article"
      return false;
    } );

    //Add a new Placemnt for an existing article
    $('#add_article_button').click( function(ev) {
      var form = $(ev.target.form);
      var added_article = $( '#add_article_select option:selected').eq(0);
      if ( form === undefined ) return true;
      $.post( form.attr('action') + '.js', form.serialize(), function( response ) { 
        $('#recent-items').append( $('<li id="placement_ids_' + response.placement.id + '" data-article-id="'+added_article.val()+'" class="peeking"></li>').append($('<h2></h2>').text( added_article.text() )));
        added_article.parents( 'form' ).effect('transfer', { to: $('#recent-items li:last'), className: 'shadow' }, 300, function() {
          $('#recent-items li:last').removeClass('peeking', 500 );
          added_article.remove();
          success_message();
        } );
      }, 'json' );
      return false;
    } );
    
    //Update Top Items
    $('#top-items').sortable({ 
      tolerance: 'intersect',
      placeholder: 'shadow-droppable',
      opacity: .7,
      items: '> li',
      containment: '#section-content',
      update: function(ev) { 
        $.post( '/placement_orderings', '_method=put&authenticity_token=' + auth_token + '&' + $('#top-items').sortable( 'serialize' ), success_message);
      },
      connectWith: [ "#recent-items", '#remove-items' ]
    });

    //Update Recent Items
    $('#recent-items').sortable( { 
      placeholder: 'shadow-droppable',
      items: '> li',
      containment: '#section-content',
      connectWith: [ '#top-items', '#remove-items' ], 
      update: function(ev) { 
        $.post( '/placement_orderings', '_method=delete&authenticity_token=' + auth_token + '&' + $('#recent-items').sortable( 'serialize' ), success_message );
      }
    } );

    //Deletion
    $('#remove-items').sortable( { 
      items: '> li',
      connectWith: [ '#top-items', '#recent-items' ], 
      placeholder: 'shadow',
      update: function(ev) { 
        
        $('#remove-title').addClass('busy');
        $.post( ('/placements/' + $('#remove-items li').attr('id').replace('placement_ids_', '')), '_method=delete&authenticity_token=' + auth_token, function(result) {
          $('#remove-items').effect('shake', { distance: 2, times: 1 }, 200);
          $('#remove-items li').effect('scale', { percent: 30 }, 300, function() { 
            $('#add_article_select').append( $( '<option></option>' ).val( $(this).attr('data-article-id') ).text( $('h2', this).text() ) );
            $(this).remove(); 
          } );
          $('#remove-title').removeClass('busy');
        } );
      }
    });
  
    //remote edit form
    $('.section_placements .remote_edit').each( function() {
      var item = $(this).parents('li').eq(0);
      var display = item.find('.edit-article-inset');
      $(this).click( function() { 
        $.get( '/articles/'+item.attr('data-article-id') +'/edit', {}, function( response ) {
          display.show('slow').addClass('peeking');
          display.html( $('<h3></h3>').text('Edit Article') ).append( response );
          display.removeClass('peeking', 3000 );

          // override form submit behavior
          $(':submit', display ).click( function(ev) {
            var form = $( ev.target.form );
            $.post( form.attr('action') + '.js', form.serialize(), function( response ) { 
              display.addClass('peeking', 1500).hide('slow');
              $('h2:first', item ).text( response.article.title );
            }, 'json' );
            return false;
          } );

          // override form cancel behavior
          $('.cancel', display ).click( function(ev) {
            display.addClass('peeking', 1500).hide('slow').html('');
            return false;
          } );
        } );
        return false;
      }) ;
    } );
    
